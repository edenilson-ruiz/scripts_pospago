--select top 1 * from DM_COMISV_POSPAGO.dbo.PagoPospagoConsolidadoDEXMasivo


--TRUNCATE TABLE TXN_POSPAGO_RENOVACIONES_MASIVO
DELETE 
FROM STG_DMSVPOS_COMI.dbo.TXN_POSPAGO_RENOVACIONES_MASIVO 
WHERE PERIODO_PAGO = '201910'
 AND CO_ID IN (
'11128299',
'12782839',
'13648985'
 )

INSERT INTO STG_DMSVPOS_COMI.dbo.TXN_POSPAGO_RENOVACIONES_MASIVO 
SELECT --INTO TXN_POSPAGO_RENOVACIONES_MASIVO 
     --CONVERT(VARCHAR(6),DATEADD(MONTH,1,CONVERT(DATETIME,X.PERIODO+'01'))) PERIODO_PAGO
     --CONVERT(VARCHAR(6),DATEADD(MONTH,1,CONVERT(DATETIME,X.PERIODO+'01')),112) PERIODO_PAGO
     '201911' PERIODO_PAGO
    ,X.PERIODO
    ,X.FECHA FECHA_ID
    ,B.DEALER_CODE
    ,B.DEALER_NAME
    ,B.DISTRIBUIDOR
    ,0 ACREEDOR_ID 
    ,B.CANAL
    ,X.CUSTOMER_ID
    ,X.DN_NUM
    ,X.CO_ID
    ,X.NOMBRE_CLIENTE
    ,X.APELLIDO_CLIENTE
    ,X.NOMBRE_COMPLETO
    ,X.NOMBRE_PLAN_ACT NOMBRE_PLAN
    ,UPPER(X.TIPO_NVO) TIPO_PLAN
    ,CASE    
        WHEN CO_EQU_TYPE = 'APORTADO' THEN 'APORTADO'
        ELSE 'CON EQUIPO'
     END TIPO_CONTRATO
    ,RENTA_MENSUAL_ACT RENTA_MENSUAL
    ,'RENOVACIONES' TRANSACCION
    ,SUM(RENTA_MENSUAL_ACT) OVER (PARTITION BY B.DISTRIBUIDOR, X.PERIODO)/1.13 TOTAL_REVENUE
    ,0 META
    ,0 ALCANCE_META_VENTA
    ,1 UNIDAD_GLOBAL
    ,0 UNIDAD_APLICA_PERMA
    ,'NO' APLICA_PERMA
    ,0 FACT_PAGADAS
    ,0 TOTAL_APLICAN_PERMA
    ,SUM(1) OVER (PARTITION BY B.DISTRIBUIDOR, X.PERIODO) TOTAL_UNIDADES
    ,0 EFECTIVIDAD_VENTAS
    ,1 FACTOR
    ,RENTA_MENSUAL_ACT * 1 COMISION
    ,( RENTA_MENSUAL_ACT * 1 ) /1.13 COMISION_SIN_IVA
    ,GETDATE() FECHA_PROCESO
    ,5 TIPOTRANS_ID
FROM (
SELECT A.*     
FROM DM_COMISV_POSPAGO.dbo.FactPospagoRenovaciones A    
WHERE PERIODO IN ('201910')
 AND A.CO_ID IN (
'11128299',
'12782839',
'13648985'
 ) 
) X INNER JOIN DM_COMISV_POSPAGO.dbo.DimDealer B ON B.DEALER_CODE = X.DEALER_CODE
WHERE X.PERIODO BETWEEN CONVERT(VARCHAR(6),B.FECHA_INI,112) AND CONVERT(VARCHAR(6),ISNULL(B.FECHA_FIN, GETDATE()),112)
    --AND NOT EXISTS (SELECT * FROM DM_COMISV_POSPAGO.dbo.FactPospagoVentas WHERE CO_ID = X.CO_ID AND PERIODO = X.PERIODO)
    AND B.CANAL = 'DISTRIBUIDORES'
    
    

INSERT INTO STG_DMSVPOS_COMI.dbo.TXN_POSPAGO_RENOVACIONES_MASIVO 
SELECT --INTO TXN_POSPAGO_RENOVACIONES_MASIVO 
     --CONVERT(VARCHAR(6),DATEADD(MONTH,1,CONVERT(DATETIME,X.PERIODO+'01'))) PERIODO_PAGO
     --CONVERT(VARCHAR(6),DATEADD(MONTH,1,CONVERT(DATETIME,X.PERIODO+'01')),112) PERIODO_PAGO
     '201810' PERIODO_PAGO
    ,X.PERIODO
    ,X.FECHA FECHA_ID
    ,B.DEALER_CODE
    ,B.DEALER_NAME
    ,B.DISTRIBUIDOR
    ,0 ACREEDOR_ID 
    ,B.CANAL
    ,X.CUSTOMER_ID
    ,X.DN_NUM
    ,X.CO_ID
    ,X.NOMBRE_CLIENTE
    ,X.APELLIDO_CLIENTE
    ,X.NOMBRE_COMPLETO
    ,X.NOMBRE_PLAN_ACT NOMBRE_PLAN
    ,UPPER(X.TIPO_NVO) TIPO_PLAN
    ,CASE    
        WHEN CO_EQU_TYPE = 'APORTADO' THEN 'APORTADO'
        ELSE 'CON EQUIPO'
     END TIPO_CONTRATO
    ,RENTA_MENSUAL_ACT RENTA_MENSUAL
    ,'RENOVACIONES' TRANSACCION
    ,SUM(RENTA_MENSUAL_ACT) OVER (PARTITION BY B.DISTRIBUIDOR, X.PERIODO)/1.13 TOTAL_REVENUE
    ,0 META
    ,0 ALCANCE_META_VENTA
    ,1 UNIDAD_GLOBAL
    ,0 UNIDAD_APLICA_PERMA
    ,'NO' APLICA_PERMA
    ,0 FACT_PAGADAS
    ,0 TOTAL_APLICAN_PERMA
    ,SUM(1) OVER (PARTITION BY B.DISTRIBUIDOR, X.PERIODO) TOTAL_UNIDADES
    ,0 EFECTIVIDAD_VENTAS
    ,1 FACTOR
    ,RENTA_MENSUAL_ACT * 1 COMISION
    ,( RENTA_MENSUAL_ACT * 1 ) /1.13 COMISION_SIN_IVA
    ,GETDATE() FECHA_PROCESO
    ,5 TIPOTRANS_ID
FROM (
SELECT A.*     
FROM STG_DMSVPOS_COMI.dbo.TXN_POSPAGO_RENOVACIONES_MASIVO A    
WHERE PERIODO IN ('201808','201809')
 AND A.CO_ID not IN (
'9612651',
'12923354',
'11093111',
'5717871',
'12078088',
'6070399',
'13040242',
'11763272',
'6936063',
'12031069',
'11470849',
'5481107',
'12160973',
'7873445',
'10787518',
'9676777',
'10903367',
'13344589',
'12969188',
'13344481',
'12583756',
'10501049'
 ) 
) X INNER JOIN DM_COMISV_POSPAGO.dbo.DimDealer B ON B.DEALER_CODE = X.DEALER_CODE
WHERE X.PERIODO BETWEEN CONVERT(VARCHAR(6),B.FECHA_INI,112) AND CONVERT(VARCHAR(6),ISNULL(B.FECHA_FIN, GETDATE()),112)
    --AND NOT EXISTS (SELECT * FROM DM_COMISV_POSPAGO.dbo.FactPospagoVentas WHERE CO_ID = X.CO_ID AND PERIODO = X.PERIODO)
    AND B.CANAL = 'DISTRIBUIDORES'




SELECT A.*     
FROM STG_DMSVPOS_COMI.dbo.TXN_POSPAGO_RENOVACIONES_MASIVO A    
WHERE PERIODO IN ('201808','201809')
 AND A.CO_ID IN (
'9612651',
'12923354',
'11093111',
'5717871',
'12078088',
'6070399',
'13040242',
'11763272',
'6936063',
'12031069',
'11470849',
'5481107',
'12160973',
'7873445',
'10787518',
'9676777',
'10903367',
'13344589',
'12969188',
'13344481',
'12583756',
'10501049'
 ) 
 
 
 select co_id, count(*) 
 from STG_DMSVPOS_COMI.dbo.TXN_POSPAGO_RENOVACIONES_MASIVO
 group by co_id
 having COUNT(*) > 1